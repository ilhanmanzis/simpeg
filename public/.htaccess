<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    # =========================
    # Security Headers (Apache)
    # =========================
    <IfModule mod_headers.c>
        # --- Anti Clickjacking ---
        Header always set X-Frame-Options "DENY"
        Header always set Content-Security-Policy "frame-ancestors 'none'"

        # --- MIME sniffing ---
        Header always set X-Content-Type-Options "nosniff"

        # --- Referrer Policy ---
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # --- Batasi fitur browser ---
        Header always set Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=(), usb=()"

        # =========================
        # âœ… Content Security Policy (CSP)
        # =========================
        # Sudah kompatibel dengan:
        # AOS, Chart.js, Flowbite, Google Fonts, Inter Font, Filament CDN, Firebase/GCP
        Header always set Content-Security-Policy "default-src 'self' http://www.w3.org; base-uri 'self'; object-src 'none'; form-action 'self'; img-src 'self' data: blob: https://firebasestorage.googleapis.com https://storage.googleapis.com; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://www.gstatic.com https://www.googletagmanager.com https://rsms.me; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://rsms.me; font-src 'self' data: https://fonts.gstatic.com https://cdn.jsdelivr.net https://rsms.me; connect-src 'self' https://cdn.jsdelivr.net https://firestore.googleapis.com https://firebase.googleapis.com https://firebasestorage.googleapis.com https://storage.googleapis.com https://www.googleapis.com https://identitytoolkit.googleapis.com; frame-ancestors 'none'"

        #Header always set Content-Security-Policy "default-src 'self' http://www.w3.org; base-uri 'self'; object-src 'none'; form-action 'self'; img-src 'self' data: blob: https://firebasestorage.googleapis.com https://storage.googleapis.com; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://www.gstatic.com https://www.googletagmanager.com https://rsms.me; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://rsms.me; font-src 'self' data: https://fonts.gstatic.com https://cdn.jsdelivr.net https://rsms.me; connect-src 'self' https://firestore.googleapis.com https://firebase.googleapis.com https://firebasestorage.googleapis.com https://storage.googleapis.com https://www.googleapis.com https://identitytoolkit.googleapis.com; frame-ancestors 'none'"

        # --- HSTS (aktifkan kalau sudah HTTPS 100%) ---
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </IfModule>

    # =========================
    # Redirect & Laravel Rules
    # =========================

    RewriteEngine On

    # Paksa HTTPS (jika belum otomatis)
    RewriteCond %{HTTPS} !=on
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle XSRF Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]

</IfModule>
